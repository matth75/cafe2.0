import{d as y,r as m,c as x,o as h,a as L,b as d,F as k,e,f,g as U,t as r,u as $,h as I,i as u,_ as C,q as R,v as F,n as O,p as B,l as E,k as D,s as M}from"./index-B6v4qw03.js";import{i as V,a as j,b as w,c as P,d as z,F as A}from"./index-DmXsHafB.js";const G={class:"calendar-actions"},N=["disabled"],T={key:0,class:"calendar-hint"},q={key:0,class:"calendar-status error"},W={key:2,class:"calendar-status empty"},J={key:3,class:"event-details"},H={key:0},K={key:1},Q="get_all",X=y({__name:"Calendar_compo",setup(S){const c=m(!1),s=m(null),n=m(null),v=m(null),_=m(null);let b=null;const i=x(()=>_.value?{plugins:[V,j,w,P,z],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"},locale:"fr",height:"auto",navLinks:!0,selectable:!0,eventClick:o,eventSources:[{id:"psee-ics",url:"https://cafe.zpq.ens-paris-saclay.fr/api/ics/get_all",format:"ics"}]}:null);function a(t){return t?t.toLocaleString("fr-FR",{weekday:"long",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"—"}function o(t){n.value={title:t.event.title,start:t.event.start,end:t.event.end,description:t.event.extendedProps?.description,location:t.event.extendedProps?.location}}async function p(){c.value=!0,s.value=null,n.value=null;try{const t=await I(Q),l=typeof t=="string"?t:t?.ics??t?.content??JSON.stringify(t);if(!l||l.length<10)throw new Error("Flux ICS vide pour la promo sélectionnée.");b&&URL.revokeObjectURL(b);const g=new Blob([l],{type:"text/calendar"});console.log("ICS Blob created:",g),b=URL.createObjectURL(g),_.value=b,console.log("ICS URL loaded:",_.value),v.value=new Date().toLocaleTimeString("fr-FR")}catch(t){console.error("Unable to load ICS feed",t),s.value="Impossible de charger le calendrier PSEE pour le moment.",_.value=null}finally{c.value=!1}}return h(()=>{p()}),L(()=>{b&&URL.revokeObjectURL(b)}),(t,l)=>(u(),d(k,null,[e("div",G,[e("button",{type:"button",class:"button primary small",disabled:c.value,onClick:p},r(c.value?"Chargement…":"Rafraîchir"),9,N),v.value?(u(),d("span",T," Mis à jour à "+r(v.value),1)):f("",!0)]),s.value?(u(),d("p",q,r(s.value),1)):f("",!0),i.value?(u(),U($(A),{key:1,class:"calendar-widget",options:i.value},null,8,["options"])):c.value?f("",!0):(u(),d("p",W," Impossible d’afficher le calendrier pour le moment. ")),n.value?(u(),d("div",J,[e("header",null,[e("h2",null,r(n.value.title),1),e("button",{class:"link-button",type:"button",onClick:l[0]||(l[0]=g=>n.value=null)},"Fermer")]),e("dl",null,[e("div",null,[l[1]||(l[1]=e("dt",null,"Début",-1)),e("dd",null,r(a(n.value.start)),1)]),e("div",null,[l[2]||(l[2]=e("dt",null,"Fin",-1)),e("dd",null,r(a(n.value.end)),1)]),n.value.location?(u(),d("div",H,[l[3]||(l[3]=e("dt",null,"Lieu",-1)),e("dd",null,r(n.value.location),1)])):f("",!0),n.value.description?(u(),d("div",K,[l[4]||(l[4]=e("dt",null,"Description",-1)),e("dd",null,r(n.value.description),1)])):f("",!0)])])):f("",!0)],64))}}),Y=C(X,[["__scopeId","data-v-982280f3"]]),Z={class:"content"},ee={class:"panel",style:{"text-align":"center"}},te=["disabled"],le={value:"",disabled:""},ne=["value"],ae={key:0,class:"panel",style:{"text-align":"center"}},oe={class:"csv button"},se={class:"button csv"},re=y({__name:"Su_cal",setup(S){const c=m([]),s=m(""),n=m("idle"),v=m("");function _(i,a){if(!i)return null;if(typeof i=="string"){const o=i.trim();return o?{value:o,label:o}:null}if(typeof i=="object"){const o=i,p=o.slug??o.id??o.value??a,t=o.label??o.name??o.title??p,l=String(p??a).trim(),g=String(t??l).trim();return l?{value:l,label:g||l}:null}return null}async function b(){n.value="loading",v.value="";const i=localStorage.getItem("cafe_token")??void 0;if(!i){c.value=[],s.value="",n.value="error",v.value="Session expirée, merci de vous reconnecter.";return}try{const a=await M(i),p=(Array.isArray(a)?a:[]).map((t,l)=>_(t,l)).filter(t=>!!t);c.value=p,s.value=p[0]?.value??"",n.value="idle",v.value=p.length?"":"Aucune promo disponible pour le moment."}catch(a){console.error("Impossible de récupérer les promos disponibles",a),c.value=[],s.value="",n.value="error",v.value="Impossible de récupérer la liste des promos disponibles."}}return h(()=>{b()}),(i,a)=>(u(),d("section",Z,[a[2]||(a[2]=e("header",{class:"major"},[e("h1",null,"Espace Superuser"),e("p",null,"Actions réservées aux administrateurs de la plateforme CAFE.")],-1)),e("div",ee,[R(e("select",{id:"promo-select","onUpdate:modelValue":a[0]||(a[0]=o=>s.value=o),disabled:n.value==="loading"||c.value.length===0},[e("option",le,r(n.value==="loading"?"Chargement…":"Sélectionnez une promo"),1),(u(!0),d(k,null,O(c.value,o=>(u(),d("option",{key:o.value,value:o.value},r(o.label),9,ne))),128))],8,te),[[F,s.value]]),v.value?(u(),d("p",{key:0,class:B(["status-banner",n.value])},r(v.value),3)):f("",!0)]),a[3]||(a[3]=e("br",null,null,-1)),s.value?(u(),d("div",ae,[e("button",oe,"Télécharger .csv "+r(s.value),1),a[1]||(a[1]=E("       ",-1)),e("button",se,"Upload le .csv "+r(s.value),1),D(Y,{promo:s.value},null,8,["promo"])])):f("",!0)]))}}),de=C(re,[["__scopeId","data-v-c957924d"]]);export{de as default};
