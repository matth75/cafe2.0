import{d as I,r as f,o as U,b as c,e,f as g,A as w,F as x,n as D,p as L,t as d,s as V,q as M,I as B,J as R,K as T,i,_ as A,P as C,a as $,g as F,k,U as N,w as K,m as j,T as q,D as z,E as O,G as S,H as G,l as H,L as J}from"./index-B6v4qw03.js";const Q={class:"info-section"},W=["for"],X=["id","value"],Y=["disabled"],Z=I({__name:"SubCalendar",setup(E){const b=f([]),t=f(null),a=f("idle"),r=f("");function p(n,l){if(!n)return null;if(typeof n=="string"){const o=n.trim();return o?{value:o,label:o}:null}if(typeof n=="object"){const o=n,v=o.slug??o.id??o.value??o.code??l,m=o.label??o.name??o.title??String(v),_=String(v??l).trim(),u=String(m??_).trim();return!_||!u?null:{value:_,label:u}}return null}async function y(){const n=localStorage.getItem("cafe_token");if(!n){b.value=[],t.value=null,a.value="error",r.value="Session expirée, merci de vous reconnecter.";return}try{const l=await V(n),v=(Array.isArray(l)?l:[]).map((m,_)=>p(m,_)).filter(m=>!!m);b.value=v,t.value=v[0]?.value??null,v.length===0?(a.value="error",r.value="Aucun calendrier disponible pour le moment."):(a.value="idle",r.value="")}catch(l){console.error("Impossible de récupérer les calendriers disponibles.",l),b.value=[],t.value=null,a.value="error",r.value="Impossible de récupérer la liste des calendriers disponibles."}}async function h(){if(a.value="idle",r.value="",!t.value){a.value="error",r.value="Aucun calendrier sélectionné.";return}const n=localStorage.getItem("cafe_token")??void 0;if(!n){a.value="error",r.value="Session expirée, merci de vous reconnecter.";return}try{await R(t.value,n),a.value="success",r.value="Promo sauvegardée.",T({promoId:t.value})}catch(l){console.error("Impossible de sauvegarder le calendrier favori.",l),a.value="error",r.value="Impossible de sauvegarder le calendrier favori."}}return U(()=>{y()}),(n,l)=>(i(),c("section",Q,[l[1]||(l[1]=e("h3",{class:"section-title"},"Cocher votre CALE favoris",-1)),l[2]||(l[2]=e("p",{class:"muted small"},null,-1)),e("form",{class:"access-form",onSubmit:w(h,["prevent"])},[(i(!0),c(x,null,D(b.value,o=>(i(),c("label",{key:o.value,class:"checkbox-pill",for:`calendar-${o.value}`},[M(e("input",{id:`calendar-${o.value}`,type:"radio",name:"favorite-calendar",value:o.value,"onUpdate:modelValue":l[0]||(l[0]=v=>t.value=v)},null,8,X),[[B,t.value]]),e("span",null,d(o.label),1)],8,W))),128)),e("button",{class:"button primary submit-button",type:"submit",disabled:!t.value}," Valider ",8,Y)],32),a.value!=="idle"?(i(),c("p",{key:0,class:L(["status-message",a.value])},d(r.value),3)):g("",!0)]))}}),ee=A(Z,[["__scopeId","data-v-aaeb0f21"]]),te={class:"content"},oe={class:"major"},se={key:0,class:"status info"},le={key:1,class:"status error"},ae={key:2,class:"profile-card"},ne={class:"profile-header"},re={class:"profile-heading"},ie={class:"profile-identity"},ue={class:"muted"},de={class:"profile-status"},ce={class:"tag"},ve={class:"profile-body"},fe={class:"info-section"},pe={class:"profile-details"},me={class:"detail"},_e={class:"detail"},be={key:0,class:"detail"},ye={class:"detail"},ge={key:0},he={key:1},ke={class:"detail"},Se={class:"profile-actions"},Ce={class:"modal-panel"},Ie=I({__name:"UserDetail",setup(E){J();const b=G(),t=f(null),a=f(null),r=f(!1),p=f(null),y=f(!1);a.value=localStorage.getItem("cafe_token");function h(){a.value||(p.value="Token d’authentification manquant. Veuillez vous reconnecter.")}async function n(){if(a.value){r.value=!0,p.value=null;try{const u=await z(a.value);t.value=O(u),localStorage.setItem("cafe_superuser",t.value?.superuser?"true":"false"),S({token:a.value,superuser:!!t.value?.superuser})}catch(u){u&&typeof u=="object"&&"response"in u&&u.response?.status===401?(p.value="Session expirée. Merci de vous reconnecter.",localStorage.removeItem("cafe_token"),localStorage.removeItem("cafe_superuser"),S({token:null,superuser:!1}),b.push({name:"login"})):p.value="Impossible de récupérer vos informations pour le moment."}finally{r.value=!1}}}function l(){n()}function o(){localStorage.removeItem("cafe_token"),localStorage.removeItem("cafe_superuser"),S({token:null,superuser:!1}),b.push({name:"login"})}function v(){y.value=!0}function m(){y.value=!1}function _(u){if(!t.value)return;const s=u.detail;!s||typeof s.promoId>"u"||(t.value.promo_id=s.promoId??!1)}return U(()=>{h(),n(),typeof window<"u"&&window.addEventListener(C,_)}),$(()=>{typeof window<"u"&&window.removeEventListener(C,_)}),(u,s)=>{const P=j("RouterLink");return i(),c("section",te,[e("header",oe,[e("h1",null,"Bienvenue "+d(t.value?.prenom),1),s[0]||(s[0]=e("p",null,"Voici les informations liées à votre compte CAFE.",-1))]),r.value?(i(),c("div",se," Chargement de vos informations… ")):p.value?(i(),c("div",le,d(p.value),1)):t.value?(i(),c("div",ae,[e("header",ne,[k(N,{"first-name":t.value.prenom,"last-name":t.value.nom},null,8,["first-name","last-name"]),e("div",re,[e("div",ie,[e("h2",null,d(t.value.prenom)+" "+d(t.value.nom),1),e("p",ue,d(t.value.email),1)]),e("div",de,[e("span",ce,d(t.value.teacher?"Prof":"Élève"),1)])])]),e("div",ve,[e("section",fe,[s[6]||(s[6]=e("h3",{class:"section-title"},"Informations de compte",-1)),e("dl",pe,[e("div",me,[s[1]||(s[1]=e("dt",null,"Identifiant",-1)),e("dd",null,d(t.value.login),1)]),e("div",_e,[s[2]||(s[2]=e("dt",null,"Date de naissance",-1)),e("dd",null,d(t.value.birthday),1)]),t.value.noteKfet?(i(),c("div",be,[s[3]||(s[3]=e("dt",null,"Note Kfet",-1)),e("dd",null,d(t.value.noteKfet||"—"),1)])):g("",!0),e("div",ye,[s[4]||(s[4]=e("dt",null,"Droits d'accès",-1)),t.value.superuser?(i(),c("dd",ge,"Superuser")):(i(),c("dd",he,"Standard"))]),e("div",ke,[s[5]||(s[5]=e("dt",null,"Promo",-1)),e("dd",null,[e("button",{class:"link-button",type:"button",onClick:v},d(t.value.promo_id?t.value.promo_id:"Sélectionner un calendrier"),1)])])])])]),e("footer",Se,[k(P,{class:"button",to:"/calendar"},{default:K(()=>[...s[7]||(s[7]=[H(" Accéder à l'agenda ",-1)])]),_:1}),e("button",{class:"button",type:"button",onClick:l}," Rafraîchir "),e("button",{class:"button primary",type:"button",onClick:o}," Se déconnecter ")])])):g("",!0),(i(),F(q,{to:"body"},[y.value?(i(),c("div",{key:0,class:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Sélection de la Promo ",onClick:w(m,["self"])},[e("div",Ce,[e("button",{class:"modal-close",type:"button",onClick:m,"aria-label":"Fermer la fenêtre"}," × "),k(ee)])])):g("",!0)]))])}}}),we=A(Ie,[["__scopeId","data-v-7955e83b"]]);export{we as default};
